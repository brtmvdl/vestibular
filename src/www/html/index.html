<!DOCTYPE html>
<html lang="en-us">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vestibular</title>
</head>

<body>
  <div id="app"></div>

  <script src="./js/nElement.js"></script>
  <script src="./js/api.js"></script>
  <script>
    const app = nElement.fromId('app')
    app.setStyle('font-family', 'serif')

    const header = new nElement()
    header.setStyle('text-align', 'center')
    const title = new nH1()
    title.setText('Vestibular')
    header.append(title)
    app.append(header)

    const testsEl = new nElement()
    app.append(testsEl)

    const questionsEl = new nElement()
    app.append(questionsEl)

    class Question extends nElement {
      constructor({ question = [], answers = [], right = 0 } = {}) {
        super({
          component: {
            name: 'question'
          }
        })

        this.question = question
        this.answers = answers
        this.right = right

        this.append(this.getQuestionHTML())
        this.append(this.getAnswersHTML())

        this.on('rightanswer', (answer) => console.log('Right answer!' + JSON.stringify(answer)))
        this.on('wronganswer', (answer) => console.log('Wrong answer!' + JSON.stringify(answer)))
      }

      getQuestionHTML() {
        const el = new nElement()

        this.question.map((q) => {
          switch (q.type) {
            case 'text': {
              const textEl = new nElement()
              textEl.setText(q.text)
              el.append(textEl)
            }; break;

            case 'image': {
              const imageEl = new nImage()
              imageEl.href(q.link)
              imageEl.alt('image')
              el.append(imageEl)
            }; break;
          }
        })

        return el
      }

      getAnswersHTML() {
        const self = this

        const el = new nElement()

        this.answers.map((q, answer) => {
          const answerEl = new nElement()
          answerEl.setText(`${String.fromCharCode(97 + answer)}: `)
          answerEl.on('click', () => {
            self.right === answer
              ? self.dispatch('rightanswer', { answer })
              : self.dispatch('wronganswer', { answer })
          })

          switch (q.type) {
            case 'text': {
              const textEl = new nElement()
              textEl.setText(q.text)
              answerEl.append(textEl)
            }; break;

            case 'image': {
              const imageEl = new nImage()
              imageEl.href(q.link)
              imageEl.alt('image')
              answerEl.append(imageEl)
            }; break;
          }

          el.append(answerEl)
        })

        return el
      }
    }

    const tests = [
      {
        where: 'UNESP',
        when: '2022-1',
        which: 0,
      }
    ]

    const clearLists = () => {
      while (tests.length > 0)
        tests.shift()

      testsEl.clear()
      questionsEl.clear()
    }

    const setTestsList = (tests = []) => {
      tests.map(({ where, when, which = 0 }) => {
        const el = new nElement()

        const whereEl = new nElement()
        whereEl.setText(where)
        el.append(whereEl)

        const whenEl = new nElement()
        whenEl.setText(when)
        el.append(whenEl)

        const startButton = new nButton()
        startButton.setText('Start')
        startButton.on('click', () => {
          clearLists()
          API.getTest({ where, when, which })
            .then((res) => res.get('list').map((q) => questionsEl.append(new Question(q))))
            .catch((err) => console.error(err))
        })
        el.append(startButton)

        testsEl.append(el)
      })
    }

    API.getTestsList({})
      .then((res) => [
        clearLists(),
        setTestsList(res.get('list', [])),
      ])
      .catch((err) => console.error(err))

  </script>
</body>

</html>